name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}

jobs:
  # Mac (Electron) 빌드 및 Notarization
  release-mac:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --ignore-scripts

      - name: Update version from tag
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "Updating version to $VERSION"
          cd apps/desktop
          npm version $VERSION --no-git-tag-version --allow-same-version

      - name: Import Code Signing Certificate
        env:
          CERTIFICATES_P12: ${{ secrets.CERTIFICATES_P12 }}
          CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
        run: |
          CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          # Import certificate from secrets
          echo -n "$CERTIFICATES_P12" | base64 --decode -o $CERTIFICATE_PATH

          # Create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Import certificate to keychain
          security import $CERTIFICATE_PATH -P "$CSC_KEY_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

          # Allow codesign to access keychain
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

      - name: Build and Notarize
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          CSC_NAME: ${{ secrets.CSC_NAME }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VITE_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: pnpm --filter @drop/desktop dist:remote

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: DROP-mac
          path: |
            apps/desktop/release/*.dmg
            apps/desktop/release/*.zip
            apps/desktop/release/*.yml

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            apps/desktop/release/*.dmg
            apps/desktop/release/*.zip
            apps/desktop/release/latest-mac.yml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # iOS (Flutter) 빌드 및 TestFlight 업로드
  release-ios:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.5'
          channel: 'stable'

      - name: Install dependencies
        working-directory: apps/mobile
        run: flutter pub get

      - name: Setup secrets
        working-directory: apps/mobile
        run: cp lib/core/config/secrets.dart.example lib/core/config/secrets.dart

      - name: Generate code
        working-directory: apps/mobile
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Setup Ruby (for CocoaPods)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Install CocoaPods
        run: gem install cocoapods

      - name: Pod Install
        working-directory: apps/mobile/ios
        run: pod install

      - name: Import Code Signing Certificate and Provisioning Profiles
        env:
          CERTIFICATES_P12: ${{ secrets.CERTIFICATES_P12 }}
          CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
          IOS_PROVISIONING_PROFILE: ${{ secrets.IOS_PROVISIONING_PROFILE }}
          IOS_SHARE_EXTENSION_PROVISIONING_PROFILE: ${{ secrets.IOS_SHARE_EXTENSION_PROVISIONING_PROFILE }}
          IOS_WIDGET_PROVISIONING_PROFILE: ${{ secrets.IOS_WIDGET_PROVISIONING_PROFILE }}
        run: |
          CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          echo -n "$CERTIFICATES_P12" | base64 --decode -o $CERTIFICATE_PATH

          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security import $CERTIFICATE_PATH -P "$CSC_KEY_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Install provisioning profiles
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo -n "$IOS_PROVISIONING_PROFILE" | base64 --decode -o ~/Library/MobileDevice/Provisioning\ Profiles/drop_mobile.mobileprovision
          echo -n "$IOS_SHARE_EXTENSION_PROVISIONING_PROFILE" | base64 --decode -o ~/Library/MobileDevice/Provisioning\ Profiles/drop_share_extension.mobileprovision
          echo -n "$IOS_WIDGET_PROVISIONING_PROFILE" | base64 --decode -o ~/Library/MobileDevice/Provisioning\ Profiles/drop_widget.mobileprovision

      - name: Configure Manual Signing
        run: |
          # List installed profiles for debugging
          echo "Installed provisioning profiles:"
          ls -la ~/Library/MobileDevice/Provisioning\ Profiles/

          # Extract profile UUIDs and rename
          for profile in ~/Library/MobileDevice/Provisioning\ Profiles/*.mobileprovision; do
            UUID=$(security cms -D -i "$profile" 2>/dev/null | plutil -extract UUID raw - 2>/dev/null || true)
            if [ -n "$UUID" ]; then
              echo "Profile UUID: $UUID"
              mv "$profile" ~/Library/MobileDevice/Provisioning\ Profiles/$UUID.mobileprovision
            fi
          done

          echo "Profiles after renaming:"
          ls -la ~/Library/MobileDevice/Provisioning\ Profiles/

      - name: Build iOS (Flutter)
        working-directory: apps/mobile
        run: |
          flutter build ios \
            --release \
            --no-codesign \
            --build-number=${{ github.run_number }} \
            --dart-define=SUPABASE_URL=${{ secrets.SUPABASE_URL }} \
            --dart-define=SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }} \
            --dart-define=OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }} \
            --dart-define=GOOGLE_WEB_CLIENT_ID=${{ secrets.GOOGLE_WEB_CLIENT_ID }} \
            --dart-define=GOOGLE_IOS_CLIENT_ID=${{ secrets.GOOGLE_IOS_CLIENT_ID }}

      - name: List Certificates
        run: |
          echo "=== Available Certificates ==="
          security find-identity -v -p codesigning
          echo "=== Provisioning Profiles ==="
          ls -la ~/Library/MobileDevice/Provisioning\ Profiles/

      - name: Archive and Export IPA
        working-directory: apps/mobile/ios
        run: |
          # Archive without code signing (signing happens during export)
          xcodebuild -workspace Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -archivePath $RUNNER_TEMP/Runner.xcarchive \
            -destination generic/platform=iOS \
            archive \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

          # Export with signing using ExportOptions.plist
          xcodebuild -exportArchive \
            -archivePath $RUNNER_TEMP/Runner.xcarchive \
            -exportPath ../build/ios/ipa \
            -exportOptionsPlist ExportOptions.plist \
            -allowProvisioningUpdates

      - name: Upload to TestFlight
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
        run: |
          xcrun altool --upload-app --type ios \
            -f apps/mobile/build/ios/ipa/*.ipa \
            -u "$APPLE_ID" \
            -p "$APPLE_APP_SPECIFIC_PASSWORD"

      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: DROP-ios-ipa
          path: apps/mobile/build/ios/ipa/*.ipa

  # Android (Flutter) 빌드 및 Firebase App Distribution 업로드
  release-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.5'
          channel: 'stable'

      - name: Setup google-services.json
        env:
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
        run: echo "$GOOGLE_SERVICES_JSON" | base64 --decode > apps/mobile/android/app/google-services.json

      - name: Setup Android Signing
        env:
          ANDROID_KEYSTORE: ${{ secrets.ANDROID_KEYSTORE }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_STORE_PASSWORD: ${{ secrets.ANDROID_STORE_PASSWORD }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          echo "$ANDROID_KEYSTORE" | base64 --decode > apps/mobile/android/drop-release.keystore
          cat > apps/mobile/android/key.properties << EOF
          storePassword=$ANDROID_STORE_PASSWORD
          keyPassword=$ANDROID_KEY_PASSWORD
          keyAlias=$ANDROID_KEY_ALIAS
          storeFile=../drop-release.keystore
          EOF

      - name: Install dependencies
        working-directory: apps/mobile
        run: flutter pub get

      - name: Setup secrets
        working-directory: apps/mobile
        run: cp lib/core/config/secrets.dart.example lib/core/config/secrets.dart

      - name: Generate code
        working-directory: apps/mobile
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Build APK
        working-directory: apps/mobile
        run: |
          flutter build apk --release \
            --build-number=${{ github.run_number }} \
            --dart-define=SUPABASE_URL=${{ secrets.SUPABASE_URL }} \
            --dart-define=SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }} \
            --dart-define=OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }} \
            --dart-define=GOOGLE_WEB_CLIENT_ID=${{ secrets.GOOGLE_WEB_CLIENT_ID }} \
            --dart-define=GOOGLE_IOS_CLIENT_ID=${{ secrets.GOOGLE_IOS_CLIENT_ID }}

      - name: Upload to Firebase App Distribution
        uses: wzieba/Firebase-Distribution-Github-Action@v1
        with:
          appId: ${{ secrets.FIREBASE_ANDROID_APP_ID }}
          serviceCredentialsFileContent: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          groups: testers
          file: apps/mobile/build/app/outputs/flutter-apk/app-release.apk

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: DROP-android-apk
          path: apps/mobile/build/app/outputs/flutter-apk/app-release.apk
